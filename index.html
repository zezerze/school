import React, { useState, useEffect } from "react";
import CryptoJS from "crypto-js";

export default function App() {
  const [users, setUsers] = useState(() => {
    const saved = localStorage.getItem("users");
    return saved ? JSON.parse(saved) : {};
  });
  const [currentUser, setCurrentUser] = useState(
    localStorage.getItem("currentUser") || null
  );
  const [showAuth, setShowAuth] = useState(!currentUser);
  const [authMode, setAuthMode] = useState("login");
  const [authForm, setAuthForm] = useState({ username: "", password: "" });

  const [tasks, setTasks] = useState([]);
  const [grades, setGrades] = useState([]);
  const [critiqueInput, setCritiqueInput] = useState("");
  const [critiqueOutput, setCritiqueOutput] = useState("");

  useEffect(() => {
    localStorage.setItem("users", JSON.stringify(users));
  }, [users]);

  useEffect(() => {
    if (currentUser) localStorage.setItem("currentUser", currentUser);
  }, [currentUser]);

  const hashPass = (pw) => CryptoJS.SHA256(pw).toString();

  const handleAuth = () => {
    const { username, password } = authForm;
    if (!username || !password) return alert("fill all fields fam");
    const hashed = hashPass(password);

    if (authMode === "signup") {
      if (users[username]) return alert("user already exists");
      const newUsers = {
        ...users,
        [username]: { password: hashed, points: 0 },
      };
      setUsers(newUsers);
      setCurrentUser(username);
      setShowAuth(false);
    } else {
      if (!users[username]) return alert("user not found");
      if (users[username].password !== hashed)
        return alert("wrong password");
      setCurrentUser(username);
      setShowAuth(false);
    }
  };

  const logout = () => {
    setCurrentUser(null);
    setShowAuth(true);
  };

  const addTask = (task) => {
    setTasks([...tasks, task]);
  };

  const completeTask = (index) => {
    const newTasks = [...tasks];
    newTasks.splice(index, 1);
    setTasks(newTasks);
    setUsers({
      ...users,
      [currentUser]: {
        ...users[currentUser],
        points: users[currentUser].points + 10,
      },
    });
  };

  const addGrade = (val) => {
    setGrades([...grades, val]);
  };

  const avgGrade =
    grades.length > 0
      ? (grades.reduce((a, b) => a + b, 0) / grades.length).toFixed(2)
      : 0;

  const getCritique = async () => {
    const API_KEY = "YOUR_OPENAI_API_KEY"; // replace with ur key
    try {
      const res = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${API_KEY}`,
        },
        body: JSON.stringify({
          model: "gpt-4o-mini",
          messages: [
            { role: "system", content: "You are a helpful study critique AI." },
            { role: "user", content: critiqueInput },
          ],
        }),
      });
      const data = await res.json();
      setCritiqueOutput(data.choices[0].message.content);
    } catch (err) {
      console.error(err);
      setCritiqueOutput("error talking to ai");
    }
  };

  return (
    <div className="p-4">
      {showAuth && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center">
          <div className="bg-white p-6 rounded-xl w-80">
            <h2 className="text-lg mb-2">{authMode === "login" ? "Log in" : "Sign up"}</h2>
            <input
              placeholder="username"
              className="border p-2 w-full mb-2"
              value={authForm.username}
              onChange={(e) =>
                setAuthForm({ ...authForm, username: e.target.value })
              }
            />
            <input
              placeholder="password"
              type="password"
              className="border p-2 w-full mb-2"
              value={authForm.password}
              onChange={(e) =>
                setAuthForm({ ...authForm, password: e.target.value })
              }
            />
            <button
              onClick={handleAuth}
              className="bg-blue-500 text-white px-3 py-1 rounded w-full"
            >
              {authMode === "login" ? "Login" : "Sign up"}
            </button>
            <p
              className="mt-2 text-sm text-blue-600 cursor-pointer"
              onClick={() =>
                setAuthMode(authMode === "login" ? "signup" : "login")
              }
            >
              {authMode === "login"
                ? "donâ€™t have an account? sign up"
                : "already got one? log in"}
            </p>
          </div>
        </div>
      )}

      {currentUser && (
        <>
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-2xl">welcome {currentUser} ðŸ‘‹</h1>
            <button
              onClick={logout}
              className="bg-red-500 text-white px-3 py-1 rounded"
            >
              logout
            </button>
          </div>

          <div className="grid grid-cols-3 gap-4">
            <div className="col-span-2">
              <h2 className="text-xl">Tasks</h2>
              <button
                onClick={() => addTask("new task")}
                className="bg-green-500 text-white px-3 py-1 rounded"
              >
                Add Task
              </button>
              <ul>
                {tasks.map((t, i) => (
                  <li key={i} className="flex justify-between items-center">
                    {t}
                    <div>
                      <button
                        onClick={() => completeTask(i)}
                        className="bg-blue-500 text-white px-2 py-1 mr-2 rounded"
                      >
                        Complete
                      </button>
                      <button
                        onClick={() =>
                          setTasks(tasks.filter((_, idx) => idx !== i))
                        }
                        className="bg-red-500 text-white px-2 py-1 rounded"
                      >
                        Remove
                      </button>
                    </div>
                  </li>
                ))}
              </ul>

              <h2 className="text-xl mt-6">Grades (avg: {avgGrade})</h2>
              <button
                onClick={() => addGrade(Math.floor(Math.random() * 100))}
                className="bg-purple-500 text-white px-3 py-1 rounded"
              >
                Add Random Grade
              </button>

              <h2 className="text-xl mt-6">Critique</h2>
              <textarea
                className="border p-2 w-full mb-2"
                value={critiqueInput}
                onChange={(e) => setCritiqueInput(e.target.value)}
              />
              <button
                onClick={getCritique}
                className="bg-indigo-500 text-white px-3 py-1 rounded"
              >
                Get Critique
              </button>
              <p className="mt-2 whitespace-pre-line">{critiqueOutput}</p>
            </div>

            <div>
              <h2 className="text-xl mb-2">Leaderboard</h2>
              <ul>
                {Object.entries(users)
                  .sort((a, b) => b[1].points - a[1].points)
                  .map(([u, data], i) => (
                    <li key={u} className="mb-1">
                      {i + 1}. {u} â€“ {data.points} pts
                    </li>
                  ))}
              </ul>
            </div>
          </div>
        </>
      )}
    </div>
  );
}
